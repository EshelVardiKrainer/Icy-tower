<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platformer Game with Screen Scroll</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; }
        #gameCanvas { background-color: #87CEEB; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <script>
        // Load sounds
        // Star powerup sounds
        const starCollectSound = new Audio('collect_star.mp3');
        const starEndSound = new Audio('star_powerup_timeout.mp3');
        // Cannon sounds
        const cannonShotSound = new Audio('cannon_shot.mp3');
        // BackGroung game sound effects
        const bgMusic = new Audio('ingame_sound_effect.mp3');
        bgMusic.loop = true; // Play it continuously
        bgMusic.volume = 0.5; // Optional: lower volume
        const gameOverMusic = new Audio('game_over_sound_effect.mp3');
        gameOverMusic.volume = 0.6; // Optional: adjust volume


        // Backgroung
        const backgroundImage = new Image();
        backgroundImage.src = 'background.jpeg';
        
        // Platform
        const platformImage = new Image();
        platformImage.src = 'platform.png';

        // Enemies characters
        const enemyImageType1 = new Image();
        enemyImageType1.src = 'enemy_type1.png'; // üêâ dark dragon
        const enemyImageType2 = new Image();
        enemyImageType2.src = 'enemy_type2.png'; // üî• red dragon

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Star power
        const starImage = new Image();
        starImage.src = 'power_star.png';
        let isInvincible = false;
        let invincibilityStartTime = 0;

        // Cannon
        const cannonImage = new Image();
        cannonImage.src = 'cannon.png';

        const knightInCannonImage = new Image();
        knightInCannonImage.src = 'knight_in_the_cannon.png';



        // Game settings
        const gravity = 0.5;
        const friction = 0.8;
        const baseJump = -10;

        let animationId = null;
        let hasStarted = false; // prevents game over at launch

        // Player
        let player = {
            x: canvas.width / 2,
            y: canvas.height - 150,
            width: 50,
            height: 50,
            speed: 5,
            velX: 0,
            velY: 0,
            jumping: false,
        };
        // Player character
        const playerImage = new Image();
        playerImage.src = 'player_character.png';

        // Scoring
        let score = 0;
        let maxPlatformLevel = -1;
        let currentLevel = 1;
        let lastScoreTime = Date.now(); // Initialize with current time

        // Platforms
        const minPlatformGap = 80;
        const maxPlatformGap = 120;
        let platforms = [];
        let prevY = canvas.height - 50;
        const verticalMoveChance = 0.06; // 6%
        const baseVerticalSpeed = 0.3;
        const speedIncreaseEvery = 50; // platforms
        const hasEnemy = Math.random() < 0.05;
        const enemyType = hasEnemy ? (Math.random() < 0.5 ? 1 : 2) : null;
        const isMovingVertically = Math.random() < verticalMoveChance;
        const hasStar = Math.random() < 0.1; // 10% chance
        const hasCannon = Math.random() < 0.04;


        for (let i = 0; i < 10; i++) {
            const gap = Math.floor(Math.random() * (maxPlatformGap - minPlatformGap + 1)) + minPlatformGap;
            const y = prevY - gap;
            prevY = y;
        
            const hasEnemy = Math.random() < 0.05;
            const enemyType = hasEnemy ? (Math.random() < 0.5 ? 1 : 2) : null;
            const isMovingVertically = Math.random() < verticalMoveChance;
        
            platforms.push({
                level: currentLevel++,
                x: Math.random() * (canvas.width - 50),
                y: y,
                width: 100 + Math.random() * 75,
                height: 10,
                timeOccupied: 0,
                isFalling: false,
                hasEnemy: hasEnemy,
                enemyType: enemyType,
                enemyX: 0,
                enemyDirection: 1,
                isMovingVertically: isMovingVertically,
                verticalDir: 1,
                verticalOffset: 0,
                hasStar: hasStar,
                hasCannon: hasCannon,
                cannonActivated: false,
            });
        }
        
        // Key Listener
        let keys = [];
        window.addEventListener('keydown', function(e) {
            keys[e.keyCode] = true;
            if (e.keyCode == 32 && !player.jumping) {
                player.jumping = true;
                player.velY = baseJump - Math.abs(player.velX);
            }
        });
        window.addEventListener('keyup', function(e) {
            keys[e.keyCode] = false;
        });

        function updateGame() {
            // Star powerup status
            if (isInvincible && Date.now() - invincibilityStartTime > 7000) {
                isInvincible = false;
                starEndSound.play(); // play end sound
            }
            

            // Play Music
            bgMusic.play();
            
            // Movement
            if (keys[39]) {
                if (player.velX < player.speed) player.velX++;
            }         
            if (keys[37]) {
                if (player.velX > -player.speed) player.velX--;
            }

            animationId = requestAnimationFrame(updateGame);
            
            if (score > 25) {
                hasStarted = true;
            }

            player.velX *= friction;
            player.velY += gravity;

            player.x += player.velX;
            player.y += player.velY;

            // Screen scroll
            if (player.y < canvas.height / 4) {
                const scrollAmount = Math.abs(player.velY);
                player.y += scrollAmount;

                platforms.forEach(platform => {
                    platform.y += scrollAmount;

                    if (platform.y > canvas.height) {
                        const lastPlatformY = Math.min(...platforms.map(p => p.y));
                        const gap = Math.floor(Math.random() * (maxPlatformGap - minPlatformGap + 1)) + minPlatformGap;
                    
                        platform.y = lastPlatformY - gap;
                        platform.x = Math.random() * (canvas.width - platform.width);
                        platform.level = currentLevel++;
                        platform.timeOccupied = 0;
                        platform.isFalling = false;
                    
                        const hasEnemy = Math.random() < 0.05;
                        const enemyType = hasEnemy ? (Math.random() < 0.5 ? 1 : 2) : null;
                        const isMovingVertically = Math.random() < verticalMoveChance;
                        const hasCannon = Math.random() < 0.04;
                    
                        platform.hasEnemy = hasEnemy;
                        platform.enemyType = enemyType;
                        platform.enemyX = 0;
                        platform.enemyDirection = 1;
                        platform.hasStar = Math.random() < 0.1;
                        platform.hasCannon = hasCannon;
                        platform.cannonActivated = false;

                    
                        // Vertical movement reset
                        platform.isMovingVertically = isMovingVertically;
                        platform.verticalOffset = 0;
                        platform.verticalDir = 1;
                    }                    
                });
            }
            const verticalSpeed = baseVerticalSpeed + Math.floor(maxPlatformLevel / speedIncreaseEvery) * 0.2;

            platforms.forEach(platform => {
                if (platform.isMovingVertically) {
                    platform.verticalOffset += verticalSpeed * platform.verticalDir;

                    if (Math.abs(platform.verticalOffset) > 20) {
                        platform.verticalDir *= -1;
                    }

                    platform.y += verticalSpeed * platform.verticalDir;
                }
            });


            // Canvas bounds
            if (player.x >= canvas.width - player.width) player.x = canvas.width - player.width;
            else if (player.x <= 0) player.x = 0;

            if (player.y >= canvas.height - player.height) {
                if (!hasStarted) {
                    // Ground acts solid before game starts
                    player.y = canvas.height - player.height;
                    player.velY = 0;
                    player.jumping = false;
                } else {
                    // Game has started, so falling = game over
                    showGameOver();
                    cancelAnimationFrame(animationId);
                }
            }
            
            // PLATFORM COLLISION + SCORING + FALLING TIMER
            platforms.forEach(platform => {
                const collidingWithPlayer =
                    player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + platform.height &&
                    player.velY >= 0;

                if (collidingWithPlayer && !platform.isFalling) {
                    // Player landed on the platform
                    player.jumping = false;
                    player.velY = 0;
                    player.y = platform.y - player.height;

                    // üöÄ Trigger cannon launch
                    if (platform.hasCannon && !platform.cannonActivated) {
                        platform.cannonActivated = true;
                        // üîä Play cannon sound
                        cannonShotSound.currentTime = 0;
                        cannonShotSound.play();
                        player.velY = -35; // immediate super jump
                        player.jumping = true;
                    }
                    
                    // Increase timer while standing
                    platform.timeOccupied += 1 / 60;

                    // Make platform fall if standing for 4 seconds
                    if (platform.timeOccupied >= 4) {
                        platform.isFalling = true;
                    }

                    // Scoring logic
                    if (platform.level > maxPlatformLevel) {
                        maxPlatformLevel = platform.level;

                        const now = Date.now();
                        const timeSinceLast = (now - lastScoreTime) / 1000;

                        let bonus = 0;
                        if (timeSinceLast < 2) {
                            bonus = Math.floor((2 - timeSinceLast) * 5);
                        }

                        score = maxPlatformLevel * 5 + bonus;
                        lastScoreTime = now;
                    }
                }
            });

            // ENEMY MOVEMENT (TYPE 2 ONLY)
            platforms.forEach(platform => {
                if (platform.hasEnemy && platform.enemyType === 2) {
                    platform.enemyX += platform.enemyDirection * 1.5;

                    if (platform.enemyX < 0 || platform.enemyX > platform.width - 20) {
                        platform.enemyDirection *= -1;
                    }
                }
            });

            // ENEMY COLLISION CHECK ‚Äî PLAYER TOUCH = GAME OVER
            platforms.forEach(platform => {
                if (platform.hasEnemy) {
                    const enemyWidth = 20;
                    const enemyHeight = 20;
                    const enemyX = platform.x + platform.enemyX;
                    const enemyY = platform.y - enemyHeight;

                    const touchingEnemy =
                        player.x < enemyX + enemyWidth &&
                        player.x + player.width > enemyX &&
                        player.y < enemyY + enemyHeight &&
                        player.y + player.height > enemyY;

                    if (touchingEnemy && !isInvincible) {
                        showGameOver();
                        cancelAnimationFrame(animationId);

                    }
                }
            });

            // Star collection
            platforms.forEach(platform => {
                if (platform.hasStar) {
                    const starSize = 24;
                    const starX = platform.x + platform.width / 2 - starSize / 2;
                    const starY = platform.y - starSize - 5;

                    const touchingStar =
                        player.x < starX + starSize &&
                        player.x + player.width > starX &&
                        player.y < starY + starSize &&
                        player.y + player.height > starY;

                    if (touchingStar) {
                        platform.hasStar = false;
                    
                        // Activate invincibility
                        isInvincible = true;
                        invincibilityStartTime = Date.now();
                    
                        // Play star collected sound
                        starCollectSound.play();
                    }       
                }
            });


            // PLATFORM BEHAVIOR: FALLING + RESET STAND TIME
            platforms.forEach(platform => {
                if (platform.isFalling) {
                    platform.y += 5;
                    if (platform.y > canvas.height + 100) {
                        platform.width = 0;
                        platform.height = 0;
                    }
                } else {
                    const playerStanding =
                        player.x + player.width > platform.x &&
                        player.x < platform.x + platform.width &&
                        player.y + player.height === platform.y;

                    if (!playerStanding) {
                        platform.timeOccupied = 0;
                    }
                }
            });

            // DRAW EVERYTHING (PLATFORMS + ENEMIES + LEVEL LABELS)

            // Clear screen
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the background
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            // Draw player with image
            ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);        
            
            // Glow effect when invincible
            if (isInvincible) {
                ctx.save();
                ctx.shadowColor = 'gold';
                ctx.shadowBlur = 15;
                ctx.strokeStyle = 'gold';
                ctx.lineWidth = 4;
            
                const centerX = player.x + player.width / 2;
                const centerY = player.y + player.height / 2;
                const radius = Math.max(player.width, player.height) / 2 + 5;
            
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }            
            
            // Draw platforms and enemies
            platforms.forEach(platform => {
                // Platform
                ctx.fillStyle = 'black';
                ctx.drawImage(platformImage, platform.x, platform.y, platform.width, platform.height);

                // Platform level label every 10 levels
                if (platform.level % 10 === 0) {
                    const label = 'Level ' + platform.level;
                    const labelX = platform.x + platform.width / 2;
                    const labelY = platform.y + platform.height / 2 + 1;

                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.strokeText(label, labelX, labelY);
                    ctx.fillStyle = 'black';
                    ctx.fillText(label, labelX, labelY);
                }

                // Enemy Draw
                if (platform.hasEnemy) {
                    const enemyX = platform.x + platform.enemyX;
                    const enemyY = platform.y - 28; // Raise a bit for better alignment
                    const enemySize = 35;
                
                    if (platform.enemyType === 1) {
                        ctx.drawImage(enemyImageType1, enemyX, enemyY, enemySize, enemySize);
                    } else if (platform.enemyType === 2) {
                        ctx.drawImage(enemyImageType2, enemyX, enemyY, enemySize, enemySize);
                    }
                }
                
                // Star powerup Draw
                if (platform.hasStar) {
                    const starSize = 24;
                    const starX = platform.x + platform.width / 2 - starSize / 2;
                    const starY = platform.y - starSize - 5;
                
                    ctx.drawImage(starImage, starX, starY, starSize, starSize);
                } 
                
                // Cannon Draw
                if (platform.hasCannon) {
                    const cannonX = platform.x + platform.width / 2 - 35;
                    const cannonY = platform.y - 35;
                
                    ctx.drawImage(cannonImage, cannonX, cannonY, 70, 70);
                }
                
            });

            // --- Draw Score Top-Left ---
            ctx.font = '16px "Press Start 2P", Arial';
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.fillText('Score: ' + score, 10, 30);

            // --- Power-Up Bar ---
            if (isInvincible) {
                const x = 10;
                const y = 40;
                const width = 120;
                const height = 8;
                const timeLeft = Math.max(0, 7000 - (Date.now() - invincibilityStartTime));
                const progress = timeLeft / 7000;
                const fillWidth = width * progress;

                const gradient = ctx.createLinearGradient(x, y, x + fillWidth, y);
                gradient.addColorStop(0, '#fff700');
                gradient.addColorStop(1, '#ffcc00');

                // Background
                ctx.fillStyle = '#333';
                ctx.fillRect(x, y, width, height);

                // Foreground (yellow bar)
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, fillWidth, height);

                // Border
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, width, height);
            }
        }

        function showGameOver() {
            // Stop music
            bgMusic.pause();
            bgMusic.currentTime = 0;
            // Play music
            gameOverMusic.play();


            // Save score
            let scores = JSON.parse(localStorage.getItem('scores') || '[]');
            scores.push(score);
            scores.sort((a, b) => b - a); // descending
            scores = scores.slice(0, 10); // keep top 10
            localStorage.setItem('scores', JSON.stringify(scores));
        
            // Update final score
            document.getElementById('finalScore').textContent = score;
        
            // Update leaderboard
            const list = document.getElementById('leaderboard');
            list.innerHTML = '';
            scores.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                list.appendChild(li);
            });
        
            // Show Game Over screen
            document.getElementById('gameOverScreen').style.display = 'block';
        }

        function restartGame() {
            // Stop game over music
            gameOverMusic.pause();
            gameOverMusic.currentTime = 0;

            // Restart music
            bgMusic.pause();
            bgMusic.currentTime = 0;

            location.reload();
        }
        
        updateGame();
    </script>
    <div id="gameOverScreen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#000000cc; color:white; text-align:center; padding-top:100px; font-family:Arial;">
        <h1>GAME OVER</h1>
        <p>Your Score: <span id="finalScore">0</span></p>
        <button onclick="restartGame()" style="padding:10px 20px; font-size:18px;">Play Again</button>
        <h2>Top Scores</h2>
        <ol id="leaderboard"></ol>
    </div>
    
</body>
</html>
